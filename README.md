# Avito Monitor Bot — мониторинг цен ноутбуков на Avito и поиск выгодных лотов

**Avito Monitor Bot** — Telegram-бот для автоматического мониторинга объявлений Avito (ноутбуки), распознавания бренда/семейства/модели и поиска недооценённых лотов для сценария **покупка → ремонт → перепродажа**.

## Возможности

- Мониторинг источников в двух режимах: URL категории Avito и текстовый запрос.
- Классификация товара по расширенному справочнику: `brand -> model_family -> model_variant` (seed с широким покрытием популярных ноутбуков).
- Улучшенное распознавание моделей:
  - нормализация кириллицы/латиницы в кодах (`т480 -> t480`, `х1 -> x1`),
  - поддержка `token`, `phrase`, `regex` алиасов,
  - автодостройка связей variant/family/brand,
  - подробный debug в `model_debug`,
  - fallback-распознавание по каноническим таблицам `brands` и `model_families` (даже если алиасы не заведены).
- Расчёт рыночной статистики (p25/p50/p75) **по конкретному товару**:
  - приоритет `model_variant`,
  - fallback на `model_family`,
  - fallback на весь search.
- Оценка потенциальной прибыли и score с учётом признаков дефектов.
- HTML-отчёты в Telegram только по новым лотам, без дублей.

## Почему это важно

Если считать медиану по всем лотам сразу, дорогие и дешёвые семейства смешиваются, и прибыль искажается. В проекте реализован корректный подход: оценка идёт от «своего рынка» модели/семейства, что даёт точнее понять, выгоден лот или нет.

## Быстрый старт

1. Установите зависимости:

```bash
pip install -r requirements.txt
```

2. Заполните `.env`:

```env
BOT_TOKEN=
DATABASE_URL=
NOTIFY_CHAT_ID=

POLL_INTERVAL_MIN=15
MAX_PAGES=10
PAGE_DELAY_S=4
BETWEEN_SEARCH_DELAY_S=80
HTTP_TIMEOUT_S=30
USER_AGENT=
```

3. Запустите приложение:

```bash
python -m src.main
```

## Команды Telegram-бота

- `/add <url|query>` — добавить источник (автоопределение типа).
- `/addcat <url>` — добавить URL категории Avito.
- `/addq <query>` — добавить текстовый запрос.
- `/list` — список источников.
- `/stats` — статистика качества классификации.
- `/unknown` — последние нераспознанные лоты.

## Как дообучать распознавание моделей

Распознавание основано на таблице `model_aliases`:

- `match_type='token'` — точный токен (`t480`, `latitude`).
- `match_type='phrase'` — устойчивые фразы (`think pad`, `elite book`).
- `match_type='regex'` — сложные шаблоны для редких написаний.

Рекомендуемый процесс:

1. Выполнить `/unknown` и собрать частые нераспознанные заголовки.
2. Проверить, что в `brands`/`model_families`/`model_variants` есть нужные канонические записи (расширенный seed заполняется автоматически).
3. Добавить алиасы в `model_aliases` с правильным весом для нестандартных написаний.
4. Проверить рост метрик через `/stats`.

## Проверка качества

Локальные тесты:

```bash
python -m unittest discover -s tests -v
```

## Стек

- Python 3
- aiogram
- asyncpg
- APScheduler
- aiohttp
- PostgreSQL
